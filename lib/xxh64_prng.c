/*
 * XXH64-PRNG
 * Blazing fast XXH64-based secure pseudo-random number generator
 *
 * Copyright (c) 2025 "dEajL3kA" <Cumpoing79@web.de>
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * https://www.opensource.org/licenses/bsd-license.php
 */

#include <xxh64_prng.h>

#include "version.h"
#include "xxh64.h"
#include <string.h>

#ifndef ENABLE_DEBUG_LOGGING
#define ENABLE_DEBUG_LOGGING 0
#endif

#if defined(__GNUC__) || defined(__clang__)
#  define FORCE_INLINE __inline__ __attribute__((__always_inline__))
#elif defined(_MSC_VER)
#  define FORCE_INLINE __forceinline
#elif defined (__cplusplus) || (defined (__STDC_VERSION__) && (__STDC_VERSION__ >= 199901L))
#  define FORCE_INLINE inline
#else
#  define FORCE_INLINE
#endif

#if defined(__BIG_ENDIAN__) || (defined(__BYTE_ORDER__) && (__BYTE_ORDER__ == __ORDER_BIG_ENDIAN__))
#  error Big-endian is not currently supported!
#endif

/* ======================================================================== */
/* Version                                                                  */
/* ======================================================================== */

const uint16_t XXH64PRNG_VERSION_MAJOR = _XXH64PRNG_VERSION_MAJOR;
const uint16_t XXH64PRNG_VERSION_MINOR = _XXH64PRNG_VERSION_MINOR;
const uint16_t XXH64PRNG_VERSION_PATCH = _XXH64PRNG_VERSION_PATCH;

const char* const XXH64PRNG_DATE = __DATE__;
const char* const XXH64PRNG_ARCH = _XXH64PRNG_ARCH;

/* ======================================================================== */
/* Debug Logging                                                            */
/* ======================================================================== */

#if ENABLE_DEBUG_LOGGING
#include <stdio.h>
static FORCE_INLINE void xxh64prng_printstate(FILE *const stream, const char *const name, const uint64_t *const state)
{
    size_t pos;
    fprintf(stream, "[xxh64prng] %s=", name);
    for (pos = 0U; pos < _XXH64PRNG_STATE_WORDS; ++pos) {
        fprintf(stream, "%016llX", state[pos]);
    }
    fputc('\n', stream);
    fflush(stream);
}
#endif

/* ======================================================================== */
/* Initialization                                                           */
/* ======================================================================== */

#define INIT_STRLEN 131U

/* Hexadecimal digits of Euler's Number */
static const char *const INIT_0[_XXH64PRNG_STATE_WORDS] = {
    "\xB7\xE1\x51\x62\x8A\xED\x2A\x6A\xBF\x71\x58\x80\x9C\xF4\xF3\xC7\x62\xE7\x16\x0F\x38\xB4\xDA\x56\xA7\x84\xD9\x04\x51\x90\xCF\xEF\x32\x4E\x77\x38\x92\x6C\xFB\xE5\xF4\xBF\x8D\x8D\x8C\x31\xD7\x63\xDA\x06\xC8\x0A\xBB\x11\x85\xEB\x4F\x7C\x7B\x57\x57\xF5\x95\x84\x90\xCF\xD4\x7D\x7C\x19\xBB\x42\x15\x8D\x95\x54\xF7\xB4\x6B\xCE\xD5\x5C\x4D\x79\xFD\x5F\x24\xD6\x61\x3C\x31\xC3\x83\x9A\x2D\xDF\x8A\x9A\x27\x6B\xCF\xBF\xA1\xC8\x77\xC5\x62\x84\xDA\xB7\x9C\xD4\xC2\xB3\x29\x3D\x20\xE9\xE5\xEA\xF0\x2A\xC6\x0A\xCC\x93\xED\x87\x44\x22\xA5",
    "\x2E\xCB\x23\x8F\xEE\xE5\xAB\x6A\xDD\x83\x5F\xD1\xA0\x75\x3D\x0A\x8F\x78\xE5\x37\xD2\xB9\x5B\xB7\x9D\x8D\xCA\xEC\x64\x2C\x1E\x9F\x23\xB8\x29\xB5\xC2\x78\x0B\xF3\x87\x37\xDF\x8B\xB3\x00\xD0\x13\x34\xA0\xD0\xBD\x86\x45\xCB\xFA\x73\xA6\x16\x0F\xFE\x39\x3C\x48\xCB\xBB\xCA\x06\x0F\x0F\xF8\xEC\x6D\x31\xBE\xB5\xCC\xEE\xD7\xF2\xF0\xBB\x08\x80\x17\x16\x3B\xC6\x0D\xF4\x5A\x0E\xCB\x1B\xCD\x28\x9B\x06\xCB\xBF\xEA\x21\xAD\x08\xE1\x84\x7F\x3F\x73\x78\xD5\x6C\xED\x94\x64\x0D\x6E\xF0\xD3\xD3\x7B\xE6\x70\x08\xE1\x86\xD1\xBF\x27\x5B\x9B",
    "\x24\x1D\xEB\x64\x74\x9A\x47\xDF\xDF\xB9\x66\x32\xC3\xEB\x06\x1B\x64\x72\xBB\xF8\x4C\x26\x14\x4E\x49\xC2\xD0\x4C\x32\x4E\xF1\x0D\xE5\x13\xD3\xF5\x11\x4B\x8B\x5D\x37\x4D\x93\xCB\x88\x79\xC7\xD5\x2F\xFD\x72\xBA\x0A\xAE\x72\x77\xDA\x7B\xA1\xB4\xAF\x14\x88\xD8\xE8\x36\xAF\x14\x86\x5E\x6C\x37\xAB\x68\x76\xFE\x69\x0B\x57\x11\x21\x38\x2A\xF3\x41\xAF\xE9\x4F\x77\xBC\xF0\x6C\x83\xB8\xFF\x56\x75\xF0\x97\x90\x74\xAD\x9A\x78\x7B\xC5\xB9\xBD\x4B\x0C\x59\x37\xD3\xED\xE4\xC3\xA7\x93\x96\x21\x5E\xDA\xB1\xF5\x7D\x0B\x5A\x7D\xB4\x61\xDD",
    "\x8F\x3C\x75\x54\x0D\x00\x12\x1F\xD5\x6E\x95\xF8\xC7\x31\xE9\xC4\xD7\x22\x1B\xBE\xD0\xC6\x2B\xB5\xA8\x78\x04\xB6\x79\xA0\xCA\xA4\x1D\x80\x2A\x46\x04\xC3\x11\xB7\x1D\xE3\xE5\xC6\xB4\x00\xE0\x24\xA6\x66\x8C\xCF\x2E\x2D\xE8\x68\x76\xE4\xF5\xC5\x00\x00\xF0\xA9\x3B\x3A\xA7\xE6\x34\x2B\x30\x2A\x0A\x47\x37\x3B\x25\xF7\x3E\x3B\x26\xD5\x69\xFE\x22\x91\xAD\x36\xD6\xA1\x47\xD1\x06\x0B\x87\x1A\x28\x01\xF9\x78\x37\x64\x08\x2F\xF5\x92\xD9\x14\x0D\xB1\xE9\x39\x9D\xF4\xB0\xE1\x4C\xA8\xE8\x8E\xE9\x11\x0B\x2B\xD4\xFA\x98\xEE\xD1\x50\xCA",
    "\x6D\xD8\x93\x22\x45\xEF\x75\x92\xC7\x03\xF5\x32\xCE\x3A\x30\xCD\x31\xC0\x70\xEB\x36\xB4\x19\x5F\xF3\x3F\xB1\xC6\x6C\x7D\x70\xF9\x39\x18\x10\x7C\xE2\x05\x1F\xED\x33\xF6\xD1\xDE\x94\x91\xC7\xDE\xA6\xA5\xA4\x42\xE1\x54\xC8\xBB\x6D\x8D\x03\x62\x80\x3B\xC2\x48\xD4\x14\x47\x8C\x2A\xFB\x07\xFF\xE7\x8E\x89\xB9\xFE\xCA\x7E\x30\x60\xC0\x8F\x0D\x61\xF8\xE3\x68\x01\xDF\x66\xD1\xD8\xF9\x39\x2E\x52\xCA\xEF\x06\x53\x19\x94\x79\xDF\x2B\xE6\x4B\xBA\xAB\x00\x8C\xA8\xA0\x6F\xDA\xCE\x9C\xE7\x04\x89\x84\x5A\x08\x2B\xA3\x6D\x61\x1E\x99\xF2",
    "\xFB\xE7\x24\x24\x6D\x18\xB5\x4E\x33\x5C\xAC\x0D\xD1\xAB\x9D\xFD\x79\x88\xA4\xB0\xC4\x55\x8A\xA1\x19\x41\x77\x20\xB6\xE1\x50\xCE\x2B\x92\x7D\x48\xD7\x25\x6E\x44\x5E\x33\x3C\xB7\x57\x2B\x3B\xD0\x0F\xB2\x74\x60\x43\x18\x9C\xAC\x11\x6C\xED\xC7\xE7\x71\xAE\x03\x58\xFF\x75\x2A\x3A\x6B\x6C\x79\xA5\x8A\x9A\x54\x9B\x50\xC5\x87\x06\x90\x75\x5C\x35\xE4\xE3\x6B\x52\x90\x38\xCA\x73\x3F\xD1\xAA\xA8\xDA\xB4\x01\x33\xD8\x03\x20\xE0\x79\x09\x68\xC7\x65\x46\xB9\x93\xF6\xC8\xFF\x3B\x25\x42\x75\x0D\xA1\xFF\xAD\xA7\xB7\x47\x31\x78\x2E\x33",
    "\x0E\xF7\xD9\x2C\x43\xBE\x1A\xD8\xC5\x0A\x8E\xAE\x20\xA5\x55\x6C\xBD\xD1\xF2\x4C\x99\x97\x2C\xB0\x3C\x73\x00\x6F\x5C\x08\xA4\xE2\x20\xE7\x4A\xBC\x17\x91\x51\x41\x2B\x1E\x2D\xD6\x0A\x08\xA1\x1B\x02\xE8\xD7\x0D\x7D\x71\x64\x58\x33\x01\x1B\xF6\x09\x45\x50\x7F\x1A\x32\x72\x1A\xC0\x8A\xED\xC2\x66\x1D\xA9\x18\x39\xD1\x46\xA2\xA4\xC4\x25\xC0\xFF\xB8\x70\x85\xF9\xB0\xE0\x9B\x94\xB1\x46\xA9\xA4\x78\x39\x08\xF3\xF2\x67\xA7\x8C\x59\x43\x04\x85\xED\x89\x20\x5B\x36\xB6\x6A\x57\xE7\x56\xE0\x06\x52\x23\x67\x02\x82\x87\xF8\xC1\xD6\x95",
    "\xDF\x88\xC6\x0F\xE0\x75\x28\xFC\xBE\x91\x5C\x7B\xF2\x33\x82\xEA\x29\x3F\xA2\xDA\x15\x77\xF9\xCA\xC2\x99\xBB\x7B\x4B\xEE\xAF\xEF\x96\x28\xC3\xEB\xEA\xF8\x71\x75\xC6\xA1\xF8\xBD\xD0\x7B\xE3\x07\xFA\x1B\xFA\x9A\xEF\xF7\x94\xC1\x9D\xFC\x36\x5F\x44\x75\x27\xDE\xA1\x10\xF4\x20\x8B\x94\x1A\xA7\xD1\x85\x38\x04\x78\xAA\x52\x0E\x3F\xE2\x33\x5A\x32\x2E\xDF\x14\x7B\xBD\xB5\x27\xAA\x2A\xD3\xCB\x0F\x7D\x6E\xD3\x81\xCD\x6A\xC3\x5A\x1D\x24\xBF\x89\xB7\x50\x19\x60\x5A\xEE\x9D\xFA\xBA\x5C\xFC\xED\x03\x3B\xA2\x10\x2A\x0B\xDB\xE3\xB4\x9D"
};

/* Hexadecimal digits of Golden Ratio */
static const char *const INIT_1[_XXH64PRNG_STATE_WORDS] = {
    "\x9E\x37\x79\xB9\x7F\x4A\x7C\x15\xF3\x9C\xC0\x60\x5C\xED\xC8\x34\x10\x82\x27\x6B\xF3\xA2\x72\x51\xF8\x6C\x6A\x11\xD0\xC1\x8E\x95\x27\x67\xF0\xB1\x53\xD2\x7B\x7F\x03\x47\x04\x5B\x5B\xF1\x82\x7F\x01\x88\x6F\x09\x28\x40\x30\x02\xC1\xD6\x4B\xA4\x0F\x33\x5E\x36\xF0\x6A\xD7\xAE\x97\x17\x87\x7E\x85\x83\x9D\x6E\xFF\xBD\x7D\xC6\x64\xD3\x25\xD1\xC5\x37\x16\x82\xCA\xDD\x0C\xCC\xFD\xFF\xBB\xE1\x62\x6E\x33\xB8\xD0\x4B\x43\x31\xBB\xF7\x3C\x79\x0D\x94\xF7\x9D\x47\x1C\x4A\xB3\xED\x3D\x82\xA5\xFE\xC5\x07\x70\x5E\x4A\xE6\xE5\xE7\x3A\x9B",
    "\x91\xF3\xAA\x4D\xB2\x87\xAE\x44\xF3\x32\xE9\x23\xA7\x3C\xB9\x16\x48\xE4\x28\xE9\x75\xA3\x78\x1E\xB0\x1B\x49\xD8\x67\x4F\xA1\x50\x84\x19\xE0\xEA\xA4\x03\x8B\x35\x2D\x9B\xAD\x30\xF4\x48\x5B\x71\xA8\xEF\x64\x45\x2A\x0D\xD4\x0D\xC8\xCB\x8F\x9A\x2D\x4C\x51\x4F\x1B\x22\x9D\xCA\xA2\x22\xAC\x26\x8E\x96\x66\xE4\xA8\x66\x76\x91\x45\xF5\xF5\x88\x0A\x9D\x0A\xCD\x3B\x9E\x8C\x68\x2F\x4F\x81\x03\x20\xAB\xEB\x94\x03\x4E\x70\xF2\x16\x08\xC0\x61\xAB\x1C\x1C\xAE\xF1\xEB\xDC\xEF\xBC\x72\x13\x4E\xCF\x06\xED\x82\xBF\xB7\xD8\xEB\x1A\x41\x90",
    "\x1D\x65\xF5\xC8\xCA\xB2\xAC\xCB\xC3\x2E\xAB\x1F\xBE\x82\x84\xF2\xB4\x4B\xA2\xE8\x34\xC5\x89\x3A\x39\xEA\x78\x65\x44\x3F\x48\x9C\x37\xF8\x74\x2A\xCD\x89\x5A\xFD\x87\xB4\x67\xD2\x2A\x40\xD0\x98\xF3\x0D\xD2\xCA\xFD\xEB\x3A\xBB\x3A\x13\x50\x7B\x46\xB3\xD7\x57\xFC\x04\x00\x19\x06\xE1\x76\x7D\x40\xC3\xA3\x79\x2A\x26\xEE\xEF\x2A\xB5\xBD\x66\x85\xB9\x15\xB5\x62\x94\x00\xFA\xA6\x84\xEC\xBA\x75\x2D\xDD\xCB\x5D\x18\x57\x6D\x77\xB6\x52\xAC\x0D\x99\x99\x73\x68\x66\x04\x12\x8F\x0C\xD4\x27\x43\x59\x6D\xEB\x2D\x42\xC7\x89\xD6\x4B\x92",
    "\x65\x86\x10\xB5\xB9\x5C\x71\x9A\xDE\xB8\xCE\x28\x73\x26\x34\x4E\x31\xD5\x9A\x59\x96\x32\x20\xB1\xA4\xC4\x27\x71\xD4\x54\xEC\x78\xF1\x23\x93\xBF\xB4\xAC\x54\x18\x8E\x59\x11\x3D\x7C\x35\x44\x1F\x15\xAA\x34\xA1\x14\x07\x03\x5F\x00\x6F\xC3\xAD\x70\xFC\x0D\x63\x31\xC6\xD4\x79\xF4\x84\xBF\x39\xCB\xFB\xD9\x5E\x66\x4E\x39\xBE\xBD\xC5\xB0\x9D\x9D\x5B\x8F\x89\x05\xD9\x80\x5C\x81\x99\x45\x7D\x44\x4A\x90\x93\x16\xCC\x58\xD3\x8B\x3A\x25\xC7\x14\xBE\x8D\x42\x29\x64\xE9\x72\x4C\x03\x3B\x67\x48\xAC\xBC\x2E\x05\xCA\xAF\x73\x7C\x95\x62",
    "\x2E\x64\x83\xFA\x07\x07\x99\x9A\xFC\x48\x29\x95\x17\x01\xC6\xED\x5F\x27\xCE\x23\x17\x70\x96\x55\x41\xF5\xF2\x87\x97\xF2\xFE\xCB\xD9\x84\xD3\x43\x5C\xE5\x47\xC8\x8C\x38\x46\x6E\x28\x65\x23\x56\x83\xD4\x44\x7E\x4B\x32\x75\x79\x03\x05\x8C\xA1\x1A\x90\x3F\x3B\xAA\x38\x64\x93\x2B\x80\xA7\xD0\x2D\x61\xB5\x0C\x1F\xF2\x81\xD5\xDD\x29\x47\xDA\x46\x24\xBB\xC7\xC7\xB9\x49\x62\x71\x7A\xED\x28\x43\x95\xC4\x2F\x25\x3C\x17\xF4\x92\xF4\x01\xBB\x6C\x17\xA9\x5C\x32\x96\xB4\x24\xDB\x05\xAF\xA8\xE7\xAD\x25\x61\xAC\xA1\xF4\xFD\x6E\x0E\xB5",
    "\x7F\x83\x1E\x40\x22\x7F\xBA\xCD\x46\x7F\xF8\xB7\xF8\x43\x70\xAE\xF7\x11\x85\x76\x34\xD0\xCF\x41\x89\x00\x2D\xDE\x87\x87\x57\x6C\x63\x1F\x0B\x9A\x17\x3C\x16\xB8\x0E\x7D\x94\x1C\x12\x8A\x54\x0C\x91\xD3\x3A\x1D\xAF\x0F\x02\x22\x98\x6E\x3C\x76\x61\xB2\xA7\xB3\x74\xDC\x06\xD8\x39\x66\x59\xE0\xFD\xE9\xB7\xB4\x1D\xC1\xBB\xB0\xF4\x29\x88\xD4\xD2\x52\x59\x06\xBD\xF6\x4A\x6E\xA5\xB1\x59\xF2\xAD\xF7\xC8\x83\xCE\x8C\x48\x08\xA9\xB4\x6E\xB9\x60\xF7\x41\x92\x01\x08\x62\xBD\x1C\x30\x65\x00\xC6\x79\x5A\x0A\x29\xDF\x4A\x34\xD4\x2B\x1A",
    "\x41\x8A\x9F\xBC\xAB\xD5\x1E\x18\x87\xAA\x0F\x8E\xBD\xF4\x45\x2D\x6E\xFB\x8D\x29\x48\xD8\x87\x82\x56\xE2\xC6\xC3\x3D\xC8\xCA\x89\xD6\x8E\x06\xAE\xAB\xD5\x6B\xCA\x17\xDE\xA2\x35\x8E\x44\x3B\x56\x72\x01\xDB\xE2\x5E\x06\xA7\x45\x1A\x73\x6B\x14\xCF\xE3\xAF\x43\x85\x22\x18\x65\x24\xDA\xD6\x9F\x05\x4B\x61\xCD\xBF\x1B\xA9\xA5\x4F\x46\xFF\x7A\x2A\x1E\x50\x90\xE0\xA2\x6D\xBE\x77\x66\xEB\xF4\x04\x75\xA2\xF1\x66\xAB\x6B\x17\x91\xB0\xEE\x0B\x48\xD8\x63\xC0\x8F\x80\x99\x67\xAC\x68\xA1\x58\xA6\xB4\xEE\xFE\x4F\xAE\x8E\xB1\xD3\x2C\xFA",
    "\x6A\x45\x73\x46\x8C\x13\x74\x01\x26\x2A\xB7\x89\x3A\x30\xCB\x01\x52\x45\xB7\x6F\xA1\x6C\xF8\x9D\xB9\x36\x47\xBB\x74\xE2\x58\x1A\xE8\x82\x3D\x14\xC0\x34\x3E\xFB\x79\x0B\x35\x76\x42\x16\x42\x8D\x6E\x98\x56\xDD\x07\x4E\xE6\xF4\x11\xEE\x1B\x5D\xD2\xA6\x70\xCC\xE1\x22\xBF\x86\x8B\xE8\x18\x52\x5E\x08\xF5\xB8\xB3\xD9\x40\x25\x2B\x85\x3B\x72\x48\xA8\x3A\xA5\x61\x61\x0F\x17\xA3\x5F\xC8\x3E\x54\x2A\x94\xFC\xB7\x16\x94\xC2\x29\xEF\x98\xF5\x07\x46\xA0\x8C\x3F\xCD\x87\x5C\xA4\xB9\x4D\x39\x0B\xBA\x41\xE6\x57\xF2\x18\x92\xB6\xEE\x0E",
};

/* Initialize state from a small 64-Bit seed */
void xxh64prng_init(xxh64prng_t *const state, const uint64_t seed)
{
    size_t pos;
    const char *const *init0 = INIT_0, *const *init1 = INIT_1;

    for (pos = 0U; pos < _XXH64PRNG_STATE_WORDS; ++pos) {
        state->state[pos] = XXH64(*init1++, INIT_STRLEN, XXH64(*init0++, INIT_STRLEN, seed));
    }
}

/* ======================================================================== */
/* Random generator                                                         */
/* ======================================================================== */

/* Hexadecimal digits of Pi */
static const uint64_t SEED[XXH64PRNG_OUTPUT_WORDS] = {
    UINT64_C(0x243F6A8885A308D3), UINT64_C(0x13198A2E03707344), UINT64_C(0xA4093822299F31D0), UINT64_C(0x082EFA98EC4E6C89),
    UINT64_C(0x452821E638D01377), UINT64_C(0xBE5466CF34E90C6C), UINT64_C(0xC0AC29B7C97C50DD), UINT64_C(0x3F84D5B5B5470917),
    UINT64_C(0x9216D5D98979FB1B), UINT64_C(0xD1310BA698DFB5AC), UINT64_C(0x2FFD72DBD01ADFB7), UINT64_C(0xB8E1AFED6A267E96),
    UINT64_C(0xBA7C9045F12C7F99), UINT64_C(0x24A19947B3916CF7), UINT64_C(0x0801F2E2858EFC16), UINT64_C(0x636920D871574E69),
    UINT64_C(0xA458FEA3F4933D7E), UINT64_C(0x0D95748F728EB658), UINT64_C(0x718BCD5882154AEE), UINT64_C(0x7B54A41DC25A59B5),
    UINT64_C(0x9C30D5392AF26013), UINT64_C(0xC5D1B023286085F0), UINT64_C(0xCA417918B8DB38EF), UINT64_C(0x8E79DCB0603A180E),
    UINT64_C(0x6C9E0E8BB01E8A3E), UINT64_C(0xD71577C1BD314B27), UINT64_C(0x78AF2FDA55605C60), UINT64_C(0xE65525F3AA55AB94),
    UINT64_C(0x5748986263E81440), UINT64_C(0x55CA396A2AAB10B6), UINT64_C(0xB4CC5C341141E8CE), UINT64_C(0xA15486AF7C72E993),
    UINT64_C(0xB3EE1411636FBC2A), UINT64_C(0x2BA9C55D741831F6), UINT64_C(0xCE5C3E169B87931E), UINT64_C(0xAFD6BA336C24CF5C),
    UINT64_C(0x7A32538128958677), UINT64_C(0x3B8F48986B4BB9AF), UINT64_C(0xC4BFE81B66282193), UINT64_C(0x61D809CCFB21A991),
    UINT64_C(0x487CAC605DEC8032), UINT64_C(0xEF845D5DE98575B1), UINT64_C(0xDC262302EB651B88), UINT64_C(0x23893E81D396ACC5),
    UINT64_C(0x0F6D6FF383F44239), UINT64_C(0x2E0B4482A4842004), UINT64_C(0x69C8F04A9E1F9B5E), UINT64_C(0x21C66842F6E96C9A),
    UINT64_C(0x670C9C61ABD388F0), UINT64_C(0x6A51A0D2D8542F68), UINT64_C(0x960FA728AB5133A3), UINT64_C(0x6EEF0B6C137A3BE4),
    UINT64_C(0xBA3BF0507EFB2A98), UINT64_C(0xA1F1651D39AF0176), UINT64_C(0x66CA593E82430E88), UINT64_C(0x8CEE8619456F9FB4),
    UINT64_C(0x7D84A5C33B8B5EBE), UINT64_C(0xE06F75D885C12073), UINT64_C(0x401A449F56C16AA6), UINT64_C(0x4ED3AA62363F7706),
    UINT64_C(0x1BFEDF72429B023D), UINT64_C(0x37D0D724D00A1248), UINT64_C(0xDB0FEAD349F1C09B), UINT64_C(0x075372C980991B7B),
    UINT64_C(0x25D479D8F6E8DEF7), UINT64_C(0xE3FE501AB6794C3B), UINT64_C(0x976CE0BD04C006BA), UINT64_C(0xC1A94FB6409F60C4),
    UINT64_C(0x5E5C9EC2196A2463), UINT64_C(0x68FB6FAF3E6C53B5), UINT64_C(0x1339B2EB3B52EC6F), UINT64_C(0x6DFC511F9B30952C),
    UINT64_C(0xCC814544AF5EBD09), UINT64_C(0xBEE3D004DE334AFD), UINT64_C(0x660F2807192E4BB3), UINT64_C(0xC0CBA85745C8740F),
    UINT64_C(0xD20B5F39B9D3FBDB), UINT64_C(0x5579C0BD1A60320A), UINT64_C(0xD6A100C6402C7279), UINT64_C(0x679F25FEFB1FA3CC),
    UINT64_C(0x8EA5E9F8DB3222F8), UINT64_C(0x3C7516DFFD616B15), UINT64_C(0x2F501EC8AD0552AB), UINT64_C(0x323DB5FAFD238760),
    UINT64_C(0x53317B483E00DF82), UINT64_C(0x9E5C57BBCA6F8CA0), UINT64_C(0x1A87562EDF1769DB), UINT64_C(0xD542A8F6287EFFC3),
    UINT64_C(0xAC6732C68C4F5573), UINT64_C(0x695B27B0BBCA58C8), UINT64_C(0xE1FFA35DB8F011A0), UINT64_C(0x10FA3D98FD2183B8),
    UINT64_C(0x4AFCB56C2DD1D35B), UINT64_C(0x9A53E479B6F84565), UINT64_C(0xD28E49BC4BFB9790), UINT64_C(0xE1DDF2DAA4CB7E33)
};

/* Internal function to iterate the state */
static FORCE_INLINE void xxh64prng_step(uint64_t *const state, uint64_t *const value)
{
    uint64_t temp0[_XXH64PRNG_STATE_WORDS];
    uint64_t temp1[_XXH64PRNG_STATE_WORDS];
    size_t pos;
    const uint64_t* seed = SEED;

    for (pos = 0U; pos < _XXH64PRNG_STATE_WORDS; ++pos) {
        temp0[pos] = state[pos];
        temp1[pos] = state[pos] ^ UINT64_MAX;
    }

    do {
        for (pos = 0U; pos < _XXH64PRNG_STATE_WORDS; ++pos) {
            value[pos] = XXH64(temp0, _XXH64PRNG_STATE_BYTES, *seed++) ^ temp0[pos];
            state[pos] = XXH64(temp1, _XXH64PRNG_STATE_BYTES, *seed++) ^ temp1[pos];
        }
    } while (!memcmp(state, temp0, _XXH64PRNG_STATE_BYTES));

    xxh64prng_zero(temp0, sizeof(temp0));
    xxh64prng_zero(temp1, sizeof(temp1));
}

/* Generate the next ouput block */
void xxh64prng_next(xxh64prng_t *const state, uint64_t *const out)
{
    uint64_t temp0[_XXH64PRNG_STATE_WORDS];
    uint64_t temp1[_XXH64PRNG_STATE_WORDS];
    size_t pos;
    const uint64_t *seed = SEED;

#if ENABLE_DEBUG_LOGGING
    xxh64prng_printstate(stderr, "state", state->state);
#endif

    xxh64prng_step(state->state, temp0);
    xxh64prng_step(state->state, temp1);

#if ENABLE_DEBUG_LOGGING
    xxh64prng_printstate(stderr, "temp0", temp0);
    xxh64prng_printstate(stderr, "temp1", temp1);
#endif

    for (pos = 0U; pos < XXH64PRNG_OUTPUT_WORDS; ++pos) {
        out[pos] = XXH64(temp1, _XXH64PRNG_STATE_BYTES, XXH64(temp0, _XXH64PRNG_STATE_BYTES, *seed++));
    }

    xxh64prng_zero(temp0, sizeof(temp0));
    xxh64prng_zero(temp1, sizeof(temp1));
}
